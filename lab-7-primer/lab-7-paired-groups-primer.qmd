---
title: "Lab 7: Hypothesis Testing - Paired Groups"
format: 
  live-html:
    webr:
      packages: 
        - ggformula
        - mosaic
        - tidyverse
      repos:
        - https://projectmosaic.r-universe.dev
      resources: 
        - https://raw.githubusercontent.com/csumb-stats-ds/stat-250-lab-primers/refs/heads/main/lab-7-primer/nvss-births-2022.csv
      cell-options:
        warning: true
        completion: false
execute: 
  warning: false 
  message: false
  echo: true
code-copy: true
code-overflow: wrap
toc: true
number-sections: true
number-depth: 4
css: ../styles.css
---

{{< include ../_extensions/r-wasm/live/_knitr.qmd >}}
{{< include ./_extensions/r-wasm/live/_gradethis.qmd >}}

```{webr}
#| label: theme
#| include: false
#| edit: false
library(ggplot2)
theme_set(theme_light())
options(ggplot2.continuous.color = scale_color_viridis_c, 
        ggplot2.continuous.fill = scale_fill_viridis_c,
        ggplot2.discrete.color = scale_color_viridis_d,
        ggplot2.discrete.fill = scale_fill_viridis_d)
```


```{r}
#| label: setup-checkdown
#| include: false
library(checkdown)
library(ggformula)
library(mosaic)
library(tidyverse)
parents <- read_csv("nvss-births-2022.csv", show_col_types = FALSE) #reads in the csv file 
```


::: {.callout-note collapse="true"}
## Digital Accessibility

Please note that all images were created with modifications to the defaults to make them digitally accessible. If you recreate this code in another environment, your plots have different colors and backgrounds.
:::


## Getting Started

Be sure to load the packages `ggformula` and `mosaic`, using the `library()` function. Remember, you need to do this with each new Quarto document or R Session. Add the package names in each of the blanks below to load in the indicated packages. 

```{webr}
#| label: setup-webr
#| exercise: ex_1
#| caption: Loading Packages
library(_________) #for graphs
library(_________) #for statistics
library(tidyverse) #for data management
```


::: {.solution exercise="ex_1"}

#### Solution

`library()` loads in packages. You need to supply the package name you need to load inside the parentheses.

```{webr}
#| exercise: ex_1
#| solution: true
library(ggformula) #for graphs
library(mosaic) #for statistics
library(tidyverse) #for data management
```

:::

```{webr}
#| exercise: ex_1
#| check: true
gradethis::grade_this_code()
```


 
::: {.callout-tip}
## Revisit Lab 5 Primer
The examples used in the Lab 6 Primer are continuations from the [Lab 5 Primer](../lab-5-primer/lab-5-two-groups-primer.qmd). We encourage you to go back and review your previous answers and code to help you with your lab.  
:::
 
 
## Birth Parents Age Gap  

A recent study found the average Homo sapiens father has always been older than the average Homo sapiens mother for 250,000 years. However, the age gap has dwindled in the last 5,000 years, largely due to mothers having children at older ages. With declining teen birth rate, rising birth rates among older women, and women pursuing higher education and careers before starting families, the average age of all mothers giving birth in the United States increased to nearly 30 in 2023. While the age gap between parents can vary greatly, it's common for fathers to be just a few years older than mothers.

The National Vital Statistics System (NVSS) is a collaborative effort between state and local governments in the US to compile and publish reports on all vital events - births, deaths, marriages, and divorces. A random sample of 50 births in 2022 was extracted from NVSS. The data for mother's age and father's age can be found in `nvss-births-2022.csv`.

**The researchers want to determine if the age gap still exists and if fathers are still older than mothers.**

Run the following code chunk to read in the data and view the variable names.

```{webr}
parents <- read_csv("nvss-births-2022.csv", show_col_types = FALSE) #reads in the csv file 
names(parents)
```


### Identify the Parameters

##### Identify the *study design* of this study. 
Be sure you are able to provide a full justification. This is review from the Lab 5 Primer.
```{r}
#| label: type-sample
#| echo: false
check_question(answer = "Matched Pair Sample", 
               options = c("Independent Two Sample", 
                           "Matched Pair Sample"), 
               type = "radio")
```
<br>



##### Identify the correct parameter type for this study. Be sure you are able to complete the full parameter in context.  

```{r}
#| label: type-parameter
#| echo: false
check_question(answer = "True mean difference", 
               options = c("True mean difference", 
                           "Difference in true means"), 
               type = "radio")
```
<br>


##### Identify the parameter(s) that would be of interest based on the study design.  

```{r}
#| label: parameter-paired
#| echo: false
check_question(answer = c("\u03BC\u2093\u1D67\u208B\u2093\u2093 = true mean of the differences of the ages in years of fathers and mothers"), 
               options = c("\u03BC\u2093\u2093 = true mean age in years of mothers", 
                           "\u03BC\u2093\u1D67 = true mean age in years of fathers",
                           "\u03BC\u2093\u2093\u208B\u2093\u1D67 = true mean of the differences of the ages in years of fathers and mothers",
                           "x\u0304\u2093\u2093
 = mean age in years of mothers in our sample",
                           "x\u0304\u2093\u1D67
 = mean age in years of fathers in our sample",
 "x\u0304\u2093\u1D67\u208B\u2093\u2093 = mean of the differences of the ages in years of fathers and mothers in our sample"), 
               type = "checkbox")
```
<br>



##### Identify the null hypothesis that would be of interest based on the study design.  
The researchers want to determine if the fathers' ages are greater than the mothers' ages at birth.  
```{r}
#| label: hyp-null
#| echo: false
check_question(answer = "\u03BC\u2093\u1D67\u208B\u2093\u2093 = 0", 
               options = c("\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 = 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 < 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 > 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 \u2260 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 = 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 < 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 > 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 \u2260 0"), 
               type = "radio")
```
<br>


##### Identify the alternative hypothesis that would be of interest based on the study design.  
The researchers want to determine if the fathers' ages are greater than the mothers' ages at birth.
```{r}
#| label: hyp-alt
#| echo: false
check_question(answer = "\u03BC\u2093\u1D67\u208B\u2093\u2093 > 0", 
               options = c("\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 = 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 < 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 > 0",
                           "\u03BC\u2093\u1D67 - \u03BC\u2093\u2093 \u2260 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 = 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 < 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 > 0",
                           "\u03BC\u2093\u1D67\u208B\u2093\u2093 \u2260 0"), 
               type = "radio")
```
<br>


### Exploratory Data Analysis 
Recall from the Lab 5 Primer, we calculated the following summary statistics and data visualizations.  


#### Summary Statistics
```{r}
#| label: summary-stats-age
df_stats(~(FatherAge - MotherAge), data = parents) 
```

#### Data Visualization
```{r}
#| label: boxplot-age
gf_boxplot(~(FatherAge - MotherAge), data = parents,
           xlab = "Difference in Ages Between Fathers and Mothers") |> 
  gf_theme(axis.ticks.y = element_blank(),  #removes y-axis ticks
           axis.text.y = element_blank())   #removes y-axis labels
```

#### QQ Plot
```{r}
#| label: qqplot-bias
gf_qq(~(FatherAge - MotherAge), data = parents,
      ylab = "Difference in Ages Between Fathers and Mothers",
      xlab = "Theoretical Z-Scores") |> 
  gf_qqline()
```


##### Based on the provided information, do we meet the necessary conditions to conduct inference using the t-distribution (e.g. confidence interval, hypothesis test)?  
  
```{r}
#| label: conditions
#| echo: false
check_question(answer = "Yes, because our sample size is greater than 30", 
               options = c("Yes, because we have random sample", 
                           "Yes, because our sample size is greater than 30", 
                           "No, because our sample data is skewed"), 
               type = "checkbox")
```


- Remember to check the conditions of sufficient sample size and normality together.  
- The sufficient sample size depends on whether our sample indicates the population may or may not be normality distributed (now evaluated using the QQ Plot).  
- Provide a statement, based on the condition check, to determine if we can or cannot use the t-distribution as a model for null distribution or sampling distribution of our test/sample statistic.


### Calculating the Test Statistic and P-Value

We will practice code for both a "by-hand" calculation and using `t.test()` (which is what we will be using from in general).  


##### Calculate the summary statistics for each sample. Modify the code below to calculate the summary statistics for each group. 


```{webr}
#| label: summary-stats-diff
#| exercise: ex_2
(mean_diff <- mean(~(FatherAge - MotherAge), data = parents))
(sd_diff <- _________(~(_____ - ____), data = ________))
(n_diff <- _______(_______$_____))
(effect_diff <- mean_diff/sd_diff)
```


::: {.solution exercise="ex_2"}

#### Solution

```{webr}
#| exercise: ex_2
#| solution: true
(mean_diff <- mean(~(FatherAge - MotherAge), data = parents))
(sd_diff <- sd(~(FatherAge - MotherAge), data = parents))
(n_diff <- length(parents$FatherAge))
(effect_diff <- mean_diff/sd_diff)
```

:::

```{webr}
#| exercise: ex_2
#| check: true
gradethis::grade_this_code()
```


### Calculating a t-Test Statistic and p-Value for the Mean of the Differences
Now that we have the necessary summary statistics saved, we can calculate both our test statistic (t) and our p-value.  Recall the t-statistic for an matched pairs test is  

$$t_0 = \frac{\bar{x}_{d} - d_0}{\frac{s_{d}}{\sqrt{n_{d}}}}$$

Fill in the blanks below using the saved object names (e.g. `mean_diff`, `sd_diff`) from above.  

```{webr}
#| label: test-stat
#| exercise: ex_3
(se <- sd_diff/sqrt(____))  #calculate the standard error
(t <- (mean_diff - ______)/_____)  #calculate the test statistic
```


::: {.solution exercise="ex_3"}

#### Solution

```{webr}
#| exercise: ex_3
#| solution: true
(se <- sd_diff/sqrt(n_diff))  #calculate the standard error
(t <- (mean_diff - 0)/se)  #calculate the test statistic(t <- (mean_f - mean_m)/se)
```

:::

```{webr}
#| exercise: ex_3
#| check: true
gradethis::grade_this_code()
```


Now, calculate the p-value using the `pt()` function. Consider the direction of the alternative hypothesis.  

```{webr}
#| label: p-value
#| exercise: ex_4
pt(___________, df = n_diff - ___)  #be sure to adjust to 2*pt() , 2*(1-pt()), or 1-pt() if needed
```


::: {.solution exercise="ex_4"}

#### Solution

```{webr}
#| exercise: ex_4
#| solution: true
1-pt(t, df = n_diff - 1)
```

:::

```{webr}
#| exercise: ex_4
#| check: true
gradethis::grade_this_code()
```


**Test statistic:**
```{r echo=FALSE}
check_question(answer = 2.5698, right = "correct", wrong = "not correct")
```

**df:**
```{r echo=FALSE}
check_question(answer = 49, right = "correct", wrong = "not correct")
```

**p-value:**
```{r echo=FALSE}
check_question(answer = 0.006634, right = "correct", wrong = "not correct")
```
<br>



Now, let's calculate the test statistic and p-value using the `t.test()` function. Consider the direction of the alternative hypothesis. Recall you have three choices for the alternative.  

- `"two.sided"`  
- `"greater"`  
- `"less"`  

```{webr}
#| label: t-test-full
#| exercise: ex_5
t.test(~(_______ - _________), data = ________, mu = __________, alternative = "________")
```

::: {.solution exercise="ex_5"}

#### Solution

```{webr}
#| exercise: ex_5
#| solution: true
t.test(~(FatherAge - MotherAge), data = parents, mu = 0, alternative = "greater")
```

:::

```{webr}
#| exercise: ex_5
#| check: true
gradethis::grade_this_code()
```


#### Switching the Direction of the Difference
Ultimately, it is up to the researcher to choose the direction of the calculated difference.  If we wanted to switch our difference and have Mother's Age - Father's Age we would have to tell R to change the ordering of inside each of our functions.  

Rerun the `t.test()` code, but calcuate the differences between Mother's Age and Father's Age instead of the other way around.  What do you have to change to make the test equivalent?  

```{webr}
#| label: t-test-full-reorder
#| exercise: ex_6
t.test(~ (_______ - _________), data = _______, mu = __________, alternative = "________")
```


::: {.solution exercise="ex_6"}

#### Solution

```{webr}
#| exercise: ex_6
#| solution: true
t.test(~(MotherAge - FatherAge), data = parents, mu = 0, alternative = "less")
```

:::

```{webr}
#| exercise: ex_6
#| check: true
gradethis::grade_this_code()
```



### Interpreting and Evaluating the p-Value
Using the calculate p-value from the `t.test()` function to answer the following questions. (Use the original ordering of Father's Age - Mother's Age). 

##### Which of the following are correct interpretations of a p-value?
```{r}
#| label: p-value-interp
#| echo: false
check_question(c("The probability of observing our test statistic or greater, assuming the null hypothesis is true"), 
               options = c("The probability of observing our test statistic", 
                           "The probability of observing our test statistic or greater", 
                           "The probability of observing our test statistic or greater, assuming the null hypothesis is true",
                           "The probability of observing our test statistic or greater, assuming the alternative hypothesis is true",
                           "The probability that the null hypothesis is true",
                           "The probability that the alternative hypothesis is true",
                           "The probability that we find evidence against the null hypothesis"), 
               type = "checkbox")
```
<br>

 

##### Evaluate the strength of evidence against the null hypothesis, using a significance level of $\alpha = 0.05$
```{r}
#| label: evaluate-p-value
#| echo: false
check_question(answer = "very strong evidence", 
               options = c("no evidence", 
                           "little evidence",
                           "some evidence",
                           "moderate evidence",
                           "strong evidence",
                           "very strong evidence"), 
               type = "radio")
```

:::{.callout-note collapse="true"}
## Full Evaluation of Strength of Evidence
Remember we have specific details to include in a full evaluation of the strength of evidence.

*We have {very strong/strong/moderate/some/little} evidence against  the null hypothesis (in favor of the alternative hypothesis) that {context of indicated hypothesis} (t = {xxx}, df = {xxx}, p-value = {xxx})*.  
:::

<br>
  
  

##### Which of the following statements are true based on the p-value?
```{r}
#| label: p-value-meaning
#| echo: false
check_question(answer = c("our data/test statistic is very unlikely to be observed if the null is true"), 
               options = c("there is a very small probability the null is true", 
                           "our data/test statistic is very unlikely to be observed if the null is true",
                           "there is a very small probability the alternative is true",
                           "there is a very large probability the alternative is true",
                           "there is a very small probability of finding evidence against the null"), 
               type = "checkbox")
```
<br>


##### Which of the following are possible, given the results of the hypothesis test?
```{r}
#| label: error-types
#| echo: false
check_question(answer = c("Our result is a Type I Error", 
                          "Our result is Correct"), 
               options = c("Our result is a Type I Error", 
                           "Our result is a Type II Error",
                           "Our result is Correct"), 
               type = "checkbox")
```
<br>


##### Which is the best definintion of *Power* in the context of the study?
```{r}
#| label: power
#| echo: false
check_question(answer = c("The probability of finding evidence of a difference in the age of parents, when there is a difference"), 
               options = c("The probability of finding no evidence of a difference in the age of parents, when there is a difference",
                           "The probability of finding no evidence of a difference in the age of parents, when there is no difference",
                           "The probability of finding evidence of a difference in the age of parents, when there is a difference",
                           "The probability of finding evidence of a difference in the age of parents, when there is no difference"), 
               type = "radio")
```
<br>



### Calculating a Confidence Interval for the Mean of the Differences
In order to calculate the confidence interval for the population mean of the differences, it takes on the same structure as a confidence interval for one population mean.  

$$point \ estimate \pm (critical \ value)*(standard\ error)$$

or 

$$\bar{x}_d \ \pm \ t^*\frac{s_d}{\sqrt{n_d}}$$

We can find our $t^*$ critical value the same way we found it for previous confidence intervals.

```{webr}
#| label: cv
(cv <- qt(1-0.05/2, df = n_diff - 1))
```

Our point estimate is $\bar{x}_d$ 

```{webr}
#| label: point-estimate
(point_estimate <- mean_diff)
```

and finally we can calculate the lower bound (`lb`) and upper bound (`ub`) for our confidence interval.
```{webr}
#| label: conf-interval-hand
(lb_rating <- point_estimate - cv*se)
(ub_rating <- point_estimate + cv*se)
```


Record the calculated confidence interval.

Lower bound:
```{r echo=FALSE}
check_question(answer = 0.3924188, right = "correct", wrong = "not correct")
```

Upper bound: 
```{r echo=FALSE}
check_question(answer = 3.2075812, right = "correct", wrong = "not correct")
```
<br>



Of course, the "by-hand" method is tedious when we can just use `t.test()` to calculate our confidence interval.  Fill in the blanks below to calculate the 95% confidence interval for the difference between the two means.  

```{webr}
#| label: ci-ttest
#| exercise: ex_7
t.test(~(_______ - _________), data = _____, conf.level = _________)$__________
```


::: {.solution exercise="ex_7"}

#### Solution

```{webr}
#| exercise: ex_7
#| solution: true
t.test(~(FatherAge - MotherAge), data = parents, conf.level = 0.95)$conf.int
```

:::

```{webr}
#| exercise: ex_7
#| check: true
gradethis::grade_this_code()
```
<br>

##### Provide an interpretation of the confidence interval by reordering the phrases below.
```{r}
#| label: ci-interpretation
#| echo: false
check_question(c("Based on the sample", 
                 "we are 95% confident that",
                 "the true mean",
                 "of the differences between",
                 "the age of fathers",
                 "and",
                 "the age of mothers",
                 "is a single value",
                 "within the interval",
                 "LB and UB"), 
               type = "in_order", alignment = "vertical")
```
<br>

##### Which of the following would be plausible estimates for the true mean of the differences between fathers' and mothers' ages?
```{r}
#| label: ci-plausible
#| echo: false
check_question(answer = c("0.5", "1", "1.5", "2"),
               options = c("0", "-1", "1", "-1.5", "-0.5", "0.5", "1.5", "-2", "2"), 
               type = "checkbox")
```
<br>

##### What can we conclude about the study?  
```{r}
#| label: conclusions
#| echo: false
check_question(answer = c("there is evidence that fathers tend to be older than mothers in 2022",
                          "we cannot infer that the age of the mother causes the age of the father to be higher",
                          "the effect size does not indicate a large difference between the ages of fathers and mothers"),
               options = c("we cannot infer that the age of the mother causes the age of the father to be higher", 
                        "we can infer that the age of the mother causes the age of the father to be higher", 
                        "there is evidence that fathers tend to be older than mothers in 2022",
                        
                        "there is no that fathers tend to be older than mothers in 2022",
                        "the effect size indicates a large difference between the ages of fathers and mothers", 
                "the effect size does not indicate a large difference between the ages of fathers and mothers"),
               type = "checkbox")
```
<br>


##### Indentify the population to which you can generalize.  
```{r}
#| label: generalize
#| echo: false
check_question("all US birth parents in 2022", 
               options = c("all Homo sapiens", 
                           "all birth parents", 
                           "all US birth parents", 
                           "all US birth parents in 2022", 
                           "all parents with an age gap", 
                           "none"), 
               type = "radio")
```


